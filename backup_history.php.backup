<?php
/**
 * Backup History - BRDSS
 * Support for external drive backups
 */
require_once 'config.php';

/** @var \PDO|null $pdo */

checkLogin();

$pageTitle = 'Backup History - BRDSS';
$message = '';
$messageType = 'success';
$currentUserId = (int)($_SESSION['user_id'] ?? 0);

// Security check: Admin only
$userRole = $_SESSION['role'] ?? '';
if ($userRole !== 'Admin' && $userRole !== 'Super Admin') {
    die('Access denied. Admin privileges required.');
}

// External backup drive configuration
define('EXTERNAL_BACKUP_PATH', '/mnt/external_drive/brdss_backups');
define('LOCAL_BACKUP_PATH', __DIR__ . '/backups');

/**
 * Get the active backup path (prefer external, fallback to local)
 */
function getBackupPath(): string
{
    if (is_dir(EXTERNAL_BACKUP_PATH) && is_writable(EXTERNAL_BACKUP_PATH)) {
        return EXTERNAL_BACKUP_PATH;
    }
    return LOCAL_BACKUP_PATH;
}

/**
 * Export database tables as CSV files in a TAR.GZ archive
 * Makes it easy for non-technical users to view and understand data
 * Uses TAR+GZIP instead of ZIP since ZIP extension may not be available
 */
function exportDatabaseAsSpreadsheet(PDO $pdo, string $archivePath): void
{
    // Create temp directory for CSV files
    $tempDir = sys_get_temp_dir() . '/brdss_backup_' . uniqid();
    
    if (!mkdir($tempDir, 0755, true)) {
        throw new Exception("Failed to create temporary directory for backup");
    }
    
    try {
        // Get all tables
        $tables = $pdo->query('SHOW TABLES')->fetchAll(PDO::FETCH_NUM);
        
        if (empty($tables)) {
            throw new Exception('No tables found in database');
        }
        
        $tableCount = 0;
        $totalRows = 0;
        
        // Export each table as CSV
        foreach ($tables as $t) {
            $table = $t[0];
            
            try {
                // Get column names
                $colsStmt = $pdo->query("SHOW COLUMNS FROM `{$table}`");
                $columns = [];
                
                while ($col = $colsStmt->fetch(PDO::FETCH_ASSOC)) {
                    $columns[] = $col['Field'];
                }
                
                if (empty($columns)) {
                    error_log("Table {$table} has no columns, skipping");
                    continue;
                }
                
                // Build CSV content
                $csv = '';
                
                // Add header row (quoted)
                $csv .= '"' . implode('","', array_map(function($c) {
                    return str_replace('"', '""', $c);
                }, $columns)) . "\"\n";
                
                // Add data rows
                $dataStmt = $pdo->query("SELECT * FROM `{$table}`", PDO::FETCH_ASSOC);
                $rowCount = 0;
                
                while ($row = $dataStmt->fetch(PDO::FETCH_ASSOC)) {
                    $vals = [];
                    foreach ($columns as $col) {
                        $val = $row[$col] ?? '';
                        $vals[] = '"' . str_replace('"', '""', (string)$val) . '"';
                    }
                    $csv .= implode(',', $vals) . "\n";
                    $rowCount++;
                }
                
                // Save CSV file
                $csvFile = $tempDir . '/' . $table . '.csv';
                if (file_put_contents($csvFile, $csv) === false) {
                    throw new Exception("Failed to write CSV file for table {$table}");
                }
                
                $tableCount++;
                $totalRows += $rowCount;
                
            } catch (Exception $tableError) {
                error_log("Error exporting table {$table}: " . $tableError->getMessage());
                // Continue with next table
                continue;
            }
        }
        
        if ($tableCount === 0) {
            throw new Exception('No tables were exported');
        }
        
        // Create README file
        $readme = "BRDSS Database Backup - Spreadsheet Format\n";
        $readme .= "========================================\n\n";
        $readme .= "Generated: " . date('Y-m-d H:i:s') . "\n";
        $readme .= "Tables exported: " . $tableCount . "\n";
        $readme .= "Total rows: " . $totalRows . "\n\n";
        $readme .= "HOW TO OPEN:\n";
        $readme .= "1. Extract this archive (right-click > Extract)\n";
        $readme .= "2. Open any CSV file with:\n";
        $readme .= "   - Microsoft Excel\n";
        $readme .= "   - Google Sheets\n";
        $readme .= "   - LibreOffice Calc\n";
        $readme .= "   - Any spreadsheet application\n\n";
        $readme .= "TABLE CONTENTS:\n";
        foreach ($tables as $t) {
            $readme .= "- " . $t[0] . ".csv\n";
        }
        $readme .= "\nNOTE: This is a TAR.GZ compressed archive. Most operating systems can extract it by right-clicking.\n";
        
        file_put_contents($tempDir . '/README.txt', $readme);
        
        // Create TAR.GZ archive using command line
        $backupDir = dirname($archivePath);
        $archiveBasename = basename($archivePath);
        
        // Use tar command to create compressed archive
        $command = "cd " . escapeshellarg($tempDir) . " && tar -czf " . 
                   escapeshellarg($archivePath) . " .";
        
        $output = [];
        $returnCode = 0;
        exec($command, $output, $returnCode);
        
        if ($returnCode !== 0) {
            throw new Exception("Failed to create archive (tar error code: {$returnCode})");
        }
        
        if (!file_exists($archivePath)) {
            throw new Exception("Archive file was not created");
        }
        
    } finally {
        // Clean up temp directory recursively
        removeBackupTempDirectory($tempDir);
    }
}

/**
 * Recursively remove a directory and its contents
 */
function removeBackupTempDirectory(string $dir): void
{
    if (!is_dir($dir)) {
        return;
    }
    
    $files = array_diff(scandir($dir), ['.', '..']);
    foreach ($files as $file) {
        $path = $dir . '/' . $file;
        if (is_dir($path)) {
            removeBackupTempDirectory($path);
        } else {
            @unlink($path);
        }
    }
    @rmdir($dir);
}

// Handle backup creation
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['create_backup'])) {
    // Increase limits for backup processing
    set_time_limit(300); // 5 minutes
    ini_set('memory_limit', '512M');
    
    try {
        $backupDir = getBackupPath();
        if (!is_dir($backupDir)) {
            if (!mkdir($backupDir, 0755, true)) {
                throw new Exception('Unable to create backup directory: ' . $backupDir);
            }
        }

        // Check if directory is writable
        if (!is_writable($backupDir)) {
            throw new Exception('Backup directory is not writable: ' . $backupDir);
        }

        // Create backup as TAR.GZ with CSV files (spreadsheet format)
        $backupFile = 'backup_' . date('Y-m-d_H-i-s') . '.tar.gz';
        $backupPath = $backupDir . '/' . $backupFile;

        exportDatabaseAsSpreadsheet($pdo, $backupPath);

        if (!file_exists($backupPath)) {
            throw new Exception('Backup file was not created: ' . $backupPath);
        }
        
        if (filesize($backupPath) === 0) {
            throw new Exception('Backup file is empty - possible database issue');
        }

        $fileSize = filesize($backupPath);
        
        // Determine storage location
        $storageType = (strpos($backupPath, EXTERNAL_BACKUP_PATH) === 0) ? 'external' : 'local';
        $backupLocation = $storageType . '/' . $backupFile;

        if ($pdo instanceof PDO) {
            $stmt = $pdo->prepare(
                "INSERT INTO backup_history (user_id, file_location, file_size, remarks, backup_date) VALUES (:user_id, :file_location, :file_size, :remarks, NOW())"
            );
            $stmt->execute([
                ':user_id' => $currentUserId,
                ':file_location' => $backupLocation,
                ':file_size' => $fileSize,
                ':remarks' => sanitize($_POST['remarks'] ?? 'Spreadsheet backup')
            ]);

            $backupId = (int)$pdo->lastInsertId();
            logActivity($currentUserId, 'Created database backup', 'CREATE', 'backup_history', $backupId);
        }

        $locationName = ($storageType === 'external') ? 'External Drive' : 'Local Storage';
        $message = 'Backup created successfully (' . number_format($fileSize / 1024 / 1024, 2) . ' MB) as spreadsheet files to ' . $locationName;
        $messageType = 'success';
    } catch (Exception $e) {
        $message = 'Error: ' . $e->getMessage();
        $messageType = 'danger';
        error_log('Backup creation error: ' . $e->getMessage());
        error_log('Stack trace: ' . $e->getTraceAsString());
    }
}

// Handle backup download
if (isset($_GET['download'])) {
    $backupId = (int)($_GET['backup_id'] ?? 0);
    
    try {
        $stmt = $pdo->prepare("SELECT file_location FROM backup_history WHERE backup_id = ? LIMIT 1");
        $stmt->execute([$backupId]);
        $backup = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$backup) {
            throw new Exception('Backup not found in database.');
        }
        
        $storedPath = $backup['file_location'];
        $fileName = basename($storedPath);
        
        // Try to find the file in both locations
        $backupPath = null;
        
        // Check external drive first
        $externalPath = EXTERNAL_BACKUP_PATH . '/' . $fileName;
        if (file_exists($externalPath)) {
            $backupPath = $externalPath;
        } else {
            // Check local storage
            $localPath = LOCAL_BACKUP_PATH . '/' . $fileName;
            if (file_exists($localPath)) {
                $backupPath = $localPath;
            }
        }
        
        if (!$backupPath) {
            throw new Exception('Backup file not found in any location.');
        }
        
        logActivity($currentUserId, 'Downloaded backup: ' . $fileName, 'DOWNLOAD', 'backup_history', $backupId);
        
        header('Content-Description: File Transfer');
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . basename($backupPath) . '"');
        header('Content-Length: ' . filesize($backupPath));
        readfile($backupPath);
        exit;
        
    } catch (Exception $e) {
        http_response_code(404);
        echo 'Error: ' . $e->getMessage();
        exit;
    }
}

// Handle backup deletion
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_backup'])) {
    try {
        $backupId = (int)($_POST['backup_id'] ?? 0);
        
        $stmt = $pdo->prepare("SELECT file_location FROM backup_history WHERE backup_id = ? LIMIT 1");
        $stmt->execute([$backupId]);
        $backup = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$backup) {
            throw new Exception('Backup not found.');
        }

        // Try to delete from both locations
        $fileName = basename($backup['file_location']);
        $deleted = false;
        
        $externalPath = EXTERNAL_BACKUP_PATH . '/' . $fileName;
        if (file_exists($externalPath)) {
            unlink($externalPath);
            $deleted = true;
        }
        
        $localPath = LOCAL_BACKUP_PATH . '/' . $fileName;
        if (file_exists($localPath)) {
            unlink($localPath);
            $deleted = true;
        }
        
        $stmt = $pdo->prepare("DELETE FROM backup_history WHERE backup_id = ?");
        $stmt->execute([$backupId]);
        
        logActivity($currentUserId, 'Deleted backup', 'DELETE', 'backup_history', $backupId);
        
        $message = 'Backup deleted successfully.';
        $messageType = 'success';
    } catch (Exception $e) {
        $message = 'Error: ' . $e->getMessage();
        $messageType = 'danger';
        error_log('Backup deletion error: ' . $e->getMessage());
    }
}

// Fetch backups
$backups = [];
try {
    $stmt = $pdo->query("
        SELECT 
            bh.backup_id,
            bh.user_id,
            bh.file_location,
            bh.file_size,
            bh.remarks,
            bh.backup_date,
            u.username
        FROM backup_history bh
        LEFT JOIN users u ON bh.user_id = u.user_id
        ORDER BY bh.backup_date DESC
    ");
    $backups = $stmt->fetchAll(PDO::FETCH_ASSOC) ?: [];
} catch (Exception $e) {
    error_log('Backup fetch error: ' . $e->getMessage());
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo sanitize($pageTitle); ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f5f5f5;
        }
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 2rem;
        }
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <?php include 'includes/sidebar.php'; ?>
    
    <div class="main-content">
        <div class="content-wrapper">
            <h2>ðŸ’¾ Backup History</h2>
            <p class="text-muted mb-4">Create and manage database backups</p>

            <div class="mb-3">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                    âž• Create Backup
                </button>
            </div>

<?php if (!empty($message)): ?>
    <div class="alert alert-<?php echo sanitize($messageType); ?> alert-dismissible fade show" role="alert">
        <?php echo sanitize($message); ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<?php endif; ?>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Location</th>
                        <th>Created By</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (!empty($backups)): ?>
                        <?php foreach ($backups as $backup): ?>
                            <?php
                            // Determine actual file location
                            $fileName = basename($backup['file_location']);
                            $actualLocation = 'Not Found';
                            
                            if (file_exists(EXTERNAL_BACKUP_PATH . '/' . $fileName)) {
                                $actualLocation = 'External';
                            } elseif (file_exists(LOCAL_BACKUP_PATH . '/' . $fileName)) {
                                $actualLocation = 'Local';
                            }
                            ?>
                            <tr>
                                <td><?php echo (int)$backup['backup_id']; ?></td>
                                <td><?php echo sanitize($fileName); ?></td>
                                <td><?php echo number_format($backup['file_size'] / 1024 / 1024, 2); ?> MB</td>
                                <td>
                                    <span class="badge bg-<?php echo $actualLocation === 'External' ? 'success' : ($actualLocation === 'Local' ? 'info' : 'secondary'); ?>">
                                        <?php echo $actualLocation; ?>
                                    </span>
                                </td>
                                <td><?php echo sanitize($backup['username'] ?? 'â€”'); ?></td>
                                <td><?php echo date('M d, Y H:i', strtotime($backup['backup_date'])); ?></td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <a href="?download=1&backup_id=<?php echo (int)$backup['backup_id']; ?>" class="btn btn-sm btn-primary">Download</a>
                                        <form method="POST" style="display:inline;" onsubmit="return confirm('Delete this backup? This action cannot be undone.');">
                                            <input type="hidden" name="backup_id" value="<?php echo (int)$backup['backup_id']; ?>">
                                            <button type="submit" name="delete_backup" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php else: ?>
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">No backups found.</td>
                        </tr>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Create Database Backup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <small>
                            <strong>Backup Location:</strong> 
                            <?php 
                            $currentPath = getBackupPath();
                            echo (strpos($currentPath, EXTERNAL_BACKUP_PATH) === 0) ? 'External Drive' : 'Local Storage';
                            ?>
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks (Optional)</label>
                        <textarea name="remarks" class="form-control" rows="3" placeholder="Add notes about this backup..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="create_backup" class="btn btn-success">Create Backup</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Auto-dismiss alerts after 5 seconds
setTimeout(() => {
    document.querySelectorAll('.alert').forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>
</body>
</html>